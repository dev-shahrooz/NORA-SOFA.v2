<!DOCTYPE html>
<html lang="fa" dir="rtl">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Nora v2</title>
    <link rel="stylesheet" href="/ui/style.css" />
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <style>
      html,body{margin:0;padding:0;font-family:system-ui, Vazirmatn, sans-serif;background:#0b0e12;color:#e6eaf0}
main{padding:16px}
.controls label{margin-inline:8px}
.controls button{margin-inline:8px;padding:8px 12px;border-radius:10px;border:1px solid #2a2f3a;background:#151922;color:#e6eaf0}
input[type="range"]{width:160px}
.reading-light { display:flex; align-items:center; gap:10px; margin:8px 0; }
.btn { padding:8px 12px; border-radius:10px; border:1px solid #2a2f3a; background:#151922; color:#e6eaf0; }
.btn.on { background:#224a1f; border-color:#2e6a29; }
.badge { padding:4px 8px; border-radius:8px; background:#242a36; color:#cfd6e3; font-size:0.9rem; }
.badge.on { background:#2a5a24; color:#e9ffe5; }
#wifi-networks{list-style:none;padding:0;margin:8px 0}
#wifi-networks li{margin:4px 0}
.wifi-connected{display:flex;align-items:center;gap:10px;margin:8px 0}
.lang-select{margin-bottom:16px}
    </style>
  </head>
  <body>
    <main>
      <section class="controls">
        <div class="lang-select">
          <select id="lang-select">
            <option value="fa">فارسی</option>
            <option value="en">English</option>
            <option value="tr">Türkçe</option>
            <option value="ar">العربية</option>
          </select>
        </div>
        <!-- Reading Light -->
        <h2 data-i18n="reading_light_title">چراغ مطالعه</h2>
        <div class="reading-light">
          <button
            id="reading-toggle"
            class="btn"
            data-i18n="reading_light_turn_on"
          >
            روشن کردن چراغ
          </button>
          <span id="reading-status" class="badge" data-i18n="status_off"
            >خاموش</span
          >
        </div>
        <hr />

        <h2 data-i18n="back_light_title">چراغ پشت (Back Light)</h2>
        <div class="back-light">
          <button id="back-toggle" class="btn" data-i18n="back_light_turn_on">
            روشن کردن چراغ پشت
          </button>
          <span id="back-status" class="badge" data-i18n="status_off"
            >خاموش</span
          >
        </div>
        <hr />
        <div class="party-mode">
          <button id="party-toggle" class="btn" data-i18n="party_mode">
            Party Mode
          </button>
        </div>
        <hr />

        <h2 data-i18n="under_sofa_title">نور زیر مبل</h2>
        <div>
          <label>
            <span data-i18n="zone_label">زون:</span>
            <select id="zone">
              <option value="under_sofa" data-i18n="zone_under_sofa">
                زیر مبل
              </option>
              <option value="box" data-i18n="zone_box">باکس</option>
            </select>
          </label>
          <label>
            <span data-i18n="mode_label">حالت:</span>
            <select id="mode">
              <option value="off" data-i18n="mode_off">خاموش</option>
              <option value="rainbow" data-i18n="mode_rainbow">رینبو</option>
              <option value="static" data-i18n="mode_static">رنگ ثابت</option>
              <option value="eq" data-i18n="mode_eq">اکولایزر</option>
            </select>
          </label>
          <label
            ><span data-i18n="color_label">رنگ:</span>
            <input type="color" id="color" value="#ffffff"
          /></label>
          <label
            ><span data-i18n="brightness_label">روشنایی:</span>
            <input type="range" id="brightness" min="0" max="255" value="128" />
          </label>
          <button id="apply-light" data-i18n="apply_light">ثبت</button>
        </div>
        <hr />
        <h2 data-i18n="bluetooth_title">بلوتوث سیستم</h2>
        <div class="bt-power">
          <button id="bt-toggle" class="btn" data-i18n="bluetooth_turn_off">
            خاموش کردن بلوتوث
          </button>
          <span id="bt-status" class="badge" data-i18n="status_on">روشن</span>
        </div>
        <div class="unpair">
          <button id="unpair" data-i18n="bluetooth_unpair">
            Unpair Bluetooth
          </button>
        </div>
        <hr />

        <h2 data-i18n="wifi_title">وای‌فای</h2>
        <div class="wifi-power">
          <button id="wifi-toggle" class="btn" data-i18n="wifi_turn_on">
            روشن کردن وای‌فای
          </button>
          <span id="wifi-status" class="badge" data-i18n="status_off"
            >خاموش</span
          >
          <button id="wifi-scan" class="btn" data-i18n="wifi_scan">
            جستجو شبکه‌ها
          </button>
        </div>
        <div class="wifi-connected" style="display: none">
          <span id="wifi-ssid"></span>
          <button id="wifi-forget" class="btn" data-i18n="wifi_forget">
            فراموش کردن
          </button>
        </div>
        <ul id="wifi-networks"></ul>
        <hr />

        <h2 data-i18n="volume_title">حجم صدا</h2>
        <div class="volume">
          <input type="range" id="volume" min="0" max="100" />
          <span id="volume-value">0</span>
        </div>

        <hr />
        <h2 data-i18n="media_player_title">مدیا پلیر</h2>
        <div class="player">
          <div class="info">
            <span id="track-title"></span>
            <span id="track-artist"></span>
          </div>
          <div class="controls">
            <button id="player-prev" class="btn" data-i18n="player_prev">
              قبلی
            </button>
            <button id="player-play" class="btn" data-i18n="player_play">
              پلی
            </button>
            <button id="player-pause" class="btn" data-i18n="player_pause">
              پاز
            </button>
            <button id="player-next" class="btn" data-i18n="player_next">
              بعدی
            </button>
          </div>
        </div>
      </section>
    </main>

    <script>
      const sio = io();

function send(type, payload = {}) {
  sio.emit("ui.intent", { type, payload, corr_id: String(Date.now()) });
}

const translations = {
  fa: {
    reading_light_title: "چراغ مطالعه",
    reading_light_turn_on: "روشن کردن چراغ",
    reading_light_turn_off: "خاموش کردن چراغ",
    status_on: "روشن",
    status_off: "خاموش",
    back_light_title: "چراغ پشت (Back Light)",
    back_light_turn_on: "روشن کردن چراغ پشت",
    back_light_turn_off: "خاموش کردن چراغ پشت",
    party_mode: "Party Mode",
    under_sofa_title: "نور زیر مبل",
    zone_label: "زون:",
    zone_under_sofa: "زیر مبل",
    zone_box: "باکس",
    mode_label: "حالت:",
    mode_off: "خاموش",
    mode_rainbow: "رینبو",
    mode_static: "رنگ ثابت",
    mode_eq: "اکولایزر",
    color_label: "رنگ:",
    brightness_label: "روشنایی:",
    apply_light: "ثبت",
    bluetooth_title: "بلوتوث سیستم",
    bluetooth_turn_on: "روشن کردن بلوتوث",
    bluetooth_turn_off: "خاموش کردن بلوتوث",
    bluetooth_unpair: "Unpair Bluetooth",
    wifi_title: "وای‌فای",
    wifi_turn_on: "روشن کردن وای‌فای",
    wifi_turn_off: "خاموش کردن وای‌فای",
    wifi_scan: "جستجو شبکه‌ها",
    wifi_forget: "فراموش کردن",
    wifi_password_prompt: "رمز برای {ssid}:",
    wifi_fail_prompt: "اتصال ناموفق بود. رمز را دوباره وارد کنید برای {ssid}:",
    volume_title: "حجم صدا",
    media_player_title: "مدیا پلیر",
    player_prev: "قبلی",
    player_play: "پلی",
    player_pause: "پاز",
    player_next: "بعدی",
  },
  en: {
    reading_light_title: "Reading Light",
    reading_light_turn_on: "Turn on light",
    reading_light_turn_off: "Turn off light",
    status_on: "On",
    status_off: "Off",
    back_light_title: "Back Light",
    back_light_turn_on: "Turn on back light",
    back_light_turn_off: "Turn off back light",
    party_mode: "Party Mode",
    under_sofa_title: "Under-sofa Lights",
    zone_label: "Zone:",
    zone_under_sofa: "Under sofa",
    zone_box: "Box",
    mode_label: "Mode:",
    mode_off: "Off",
    mode_rainbow: "Rainbow",
    mode_static: "Static color",
    mode_eq: "Equalizer",
    color_label: "Color:",
    brightness_label: "Brightness:",
    apply_light: "Apply",
    bluetooth_title: "System Bluetooth",
    bluetooth_turn_on: "Turn on Bluetooth",
    bluetooth_turn_off: "Turn off Bluetooth",
    bluetooth_unpair: "Unpair Bluetooth",
    wifi_title: "Wi-Fi",
    wifi_turn_on: "Turn on Wi-Fi",
    wifi_turn_off: "Turn off Wi-Fi",
    wifi_scan: "Scan Networks",
    wifi_forget: "Forget",
    wifi_password_prompt: "Password for {ssid}:",
    wifi_fail_prompt: "Connection failed. Enter password again for {ssid}:",
    volume_title: "Volume",
    media_player_title: "Media Player",
    player_prev: "Previous",
    player_play: "Play",
    player_pause: "Pause",
    player_next: "Next",
  },
  tr: {
    reading_light_title: "Okuma Lambası",
    reading_light_turn_on: "Lambayı aç",
    reading_light_turn_off: "Lambayı kapat",
    status_on: "Açık",
    status_off: "Kapalı",
    back_light_title: "Arka Işık",
    back_light_turn_on: "Arka ışığı aç",
    back_light_turn_off: "Arka ışığı kapat",
    party_mode: "Parti Modu",
    under_sofa_title: "Koltuk Altı Işıkları",
    zone_label: "Bölge:",
    zone_under_sofa: "Koltuk altı",
    zone_box: "Kutu",
    mode_label: "Mod:",
    mode_off: "Kapalı",
    mode_rainbow: "Gökkuşağı",
    mode_static: "Sabit renk",
    mode_eq: "Ekolayzır",
    color_label: "Renk:",
    brightness_label: "Parlaklık:",
    apply_light: "Uygula",
    bluetooth_title: "Sistem Bluetooth'u",
    bluetooth_turn_on: "Bluetooth'u aç",
    bluetooth_turn_off: "Bluetooth'u kapat",
    bluetooth_unpair: "Bluetooth eşlemesini kaldır",
    wifi_title: "Wi-Fi",
    wifi_turn_on: "Wi-Fi'yi aç",
    wifi_turn_off: "Wi-Fi'yi kapat",
    wifi_scan: "Ağları Tara",
    wifi_forget: "Unut",
    wifi_password_prompt: "{ssid} için parola:",
    wifi_fail_prompt: "Bağlantı başarısız. {ssid} için parolayı tekrar girin:",
    volume_title: "Ses",
    media_player_title: "Medya Oynatıcı",
    player_prev: "Önceki",
    player_play: "Oynat",
    player_pause: "Duraklat",
    player_next: "Sonraki",
  },
  ar: {
    reading_light_title: "مصباح القراءة",
    reading_light_turn_on: "تشغيل المصباح",
    reading_light_turn_off: "إيقاف المصباح",
    status_on: "تشغيل",
    status_off: "إيقاف",
    back_light_title: "الإضاءة الخلفية",
    back_light_turn_on: "تشغيل الإضاءة الخلفية",
    back_light_turn_off: "إيقاف الإضاءة الخلفية",
    party_mode: "وضع الحفلة",
    under_sofa_title: "إضاءة تحت الأريكة",
    zone_label: "منطقة:",
    zone_under_sofa: "تحت الأريكة",
    zone_box: "الصندوق",
    mode_label: "وضع:",
    mode_off: "إيقاف",
    mode_rainbow: "قوس قزح",
    mode_static: "لون ثابت",
    mode_eq: "موازن",
    color_label: "لون:",
    brightness_label: "السطوع:",
    apply_light: "تطبيق",
    bluetooth_title: "بلوتوث النظام",
    bluetooth_turn_on: "تشغيل البلوتوث",
    bluetooth_turn_off: "إيقاف البلوتوث",
    bluetooth_unpair: "إلغاء اقتران البلوتوث",
    wifi_title: "واي فاي",
    wifi_turn_on: "تشغيل الواي فاي",
    wifi_turn_off: "إيقاف الواي فاي",
    wifi_scan: "مسح الشبكات",
    wifi_forget: "نسيان",
    wifi_password_prompt: "كلمة المرور لـ {ssid}:",
    wifi_fail_prompt: "فشل الاتصال. أدخل كلمة المرور مرة أخرى لـ {ssid}:",
    volume_title: "مستوى الصوت",
    media_player_title: "مشغل الوسائط",
    player_prev: "السابق",
    player_play: "تشغيل",
    player_pause: "إيقاف مؤقت",
    player_next: "التالي",
  },
};

let currentLang = "fa";
let lastState = {};

function t(key, vars = {}) {
  let str = translations[currentLang][key] || key;
  Object.keys(vars).forEach((k) => {
    str = str.replace(`{${k}}`, vars[k]);
  });
  return str;
}

function applyTranslations() {
  document.documentElement.lang = currentLang;
  document.documentElement.dir = ["fa", "ar"].includes(currentLang)
    ? "rtl"
    : "ltr";
  document.querySelectorAll("[data-i18n]").forEach((el) => {
    const key = el.getAttribute("data-i18n");
    el.textContent = t(key);
  });
  renderReadingLight(lastState);
  renderBackLight(lastState);
  renderPartyMode(lastState);
  renderBluetooth(lastState);
  renderWiFi(lastState);
  renderVolume(lastState);
  renderPlayer(lastState);
}

function setLang(lang) {
  currentLang = lang;
  applyTranslations();
  send("ui.set_lang", { lang });
}

// ---- UI Elements ----
const langSelect = document.getElementById("lang-select");
const readingBtn = document.getElementById("reading-toggle");
const readingStatus = document.getElementById("reading-status");
const backBtn = document.getElementById("back-toggle");
const backStatus = document.getElementById("back-status");
const partyBtn = document.getElementById("party-toggle");
const btBtn = document.getElementById("bt-toggle");
const btStatus = document.getElementById("bt-status");
const wifiBtn = document.getElementById("wifi-toggle");
const wifiStatus = document.getElementById("wifi-status");
const wifiScanBtn = document.getElementById("wifi-scan");
const wifiList = document.getElementById("wifi-networks");
const wifiSSID = document.getElementById("wifi-ssid");
const wifiForgetBtn = document.getElementById("wifi-forget");
const wifiConnected = document.querySelector(".wifi-connected");
let pendingSSID = null;
let wifiScanRequested = false;
const volumeRange = document.getElementById("volume");
const volumeValue = document.getElementById("volume-value");
const playBtn = document.getElementById("player-play");
const pauseBtn = document.getElementById("player-pause");
const nextBtn = document.getElementById("player-next");
const prevBtn = document.getElementById("player-prev");
const trackTitle = document.getElementById("track-title");
const trackArtist = document.getElementById("track-artist");

// ---- Rendering Functions ----
function renderReadingLight(st) {
  const on = !!st?.lighting?.reading_light?.on;
  if (on) {
    readingBtn.textContent = t("reading_light_turn_off");
    readingBtn.classList.add("on");
    readingStatus.textContent = t("status_on");
    readingStatus.classList.add("on");
  } else {
    readingBtn.textContent = t("reading_light_turn_on");
    readingBtn.classList.remove("on");
    readingStatus.textContent = t("status_off");
    readingStatus.classList.remove("on");
  }
}

function renderPartyMode(st) {
  const active = st.mode === "party";
  if (active) {
    partyBtn.classList.add("on");
  } else {
    partyBtn.classList.remove("on");
  }
}

function renderBluetooth(st) {
  const on = !!st?.bluetooth?.on;
  if (on) {
    btBtn.textContent = t("bluetooth_turn_off");
    btBtn.classList.add("on");
    btStatus.textContent = t("status_on");
    btStatus.classList.add("on");
  } else {
    btBtn.textContent = t("bluetooth_turn_on");
    btBtn.classList.remove("on");
    btStatus.textContent = t("status_off");
    btStatus.classList.remove("on");
  }
}

function renderWiFi(st) {
  const wifi = st?.wifi || {};
  const on = !!wifi.on;
  if (on) {
    wifiBtn.textContent = t("wifi_turn_off");
    wifiBtn.classList.add("on");
    wifiStatus.textContent = t("status_on");
    wifiStatus.classList.add("on");
    wifiScanBtn.disabled = false;
    if (!wifiScanRequested && !wifi.networks) {
      wifiScanRequested = true;
      send("wifi.scan");
    }
  } else {
    wifiBtn.textContent = t("wifi_turn_on");
    wifiBtn.classList.remove("on");
    wifiStatus.textContent = t("status_off");
    wifiStatus.classList.remove("on");
    wifiScanBtn.disabled = true;
    wifiScanRequested = false;
  }

  // Connected network
  if (wifi.connected) {
    wifiSSID.textContent = wifi.ssid || "";
    wifiForgetBtn.style.display = "inline";
    wifiConnected.style.display = "flex";
  } else {
    wifiSSID.textContent = "";
    wifiForgetBtn.style.display = "none";
    wifiConnected.style.display = "none";
  }

  // Render network list
  wifiList.innerHTML = "";
  (wifi.networks || []).forEach((net) => {
    const li = document.createElement("li");
    const btn = document.createElement("button");
    btn.textContent = `${net.ssid} (${net.signal})`;
    btn.className = "btn";
    btn.onclick = () => connectSSID(net.ssid);
    li.appendChild(btn);
    wifiList.appendChild(li);
  });

  // handle pending connection result
  if (pendingSSID) {
    if (wifi.connected && wifi.ssid === pendingSSID) {
      pendingSSID = null;
    } else if (!wifi.connected && wifi.ssid === "") {
      const pwd = prompt(t("wifi_fail_prompt", { ssid: pendingSSID }));
      if (pwd !== null) {
        send("wifi.connect", { ssid: pendingSSID, password: pwd });
      } else {
        pendingSSID = null;
      }
    }
  }
}

function renderVolume(st) {
  const vol = st?.audio?.volume ?? 0;
  volumeRange.value = vol;
  volumeValue.textContent = vol;
}

function renderPlayer(st) {
  const p = st?.player || {};
  trackTitle.textContent = p.title || "";
  trackArtist.textContent = p.artist || "";
}

function renderBackLight(st) {
  const on = !!st?.lighting?.back_light?.on;
  if (on) {
    backBtn.textContent = t("back_light_turn_off");
    backBtn.classList.add("on");
    backStatus.textContent = t("status_on");
    backStatus.classList.add("on");
  } else {
    backBtn.textContent = t("back_light_turn_on");
    backBtn.classList.remove("on");
    backStatus.textContent = t("status_off");
    backStatus.classList.remove("on");
  }
}

// ---- Event Handlers ----
readingBtn.onclick = () => {
  const next = !readingStatus.classList.contains("on");
  send("reading_light.set", { on: next });
};

partyBtn.onclick = () => {
  send("mode.toggle");
};

btBtn.onclick = () => {
  const next = !btStatus.classList.contains("on");
  send("bluetooth.set", { on: next });
};

wifiBtn.onclick = () => {
  const next = !wifiStatus.classList.contains("on");
  send("wifi.set", { on: next });
};

wifiScanBtn.onclick = () => send("wifi.scan");

wifiForgetBtn.onclick = () => {
  const ssid = wifiSSID.textContent;
  if (ssid) send("wifi.forget", { ssid });
};

function connectSSID(ssid) {
  const pwd = prompt(t("wifi_password_prompt", { ssid }));
  if (pwd !== null) {
    pendingSSID = ssid;
    send("wifi.connect", { ssid, password: pwd });
  }
}

playBtn.onclick = () => send("player.play");
pauseBtn.onclick = () => send("player.pause");
nextBtn.onclick = () => send("player.next");
prevBtn.onclick = () => send("player.previous");

backBtn.onclick = () => {
  const next = !backStatus.classList.contains("on");
  send("back_light.set", { on: next });
};

// Query initial state
sio.emit("ui.query", {});

sio.on("sv.update", (st) => {
  lastState = st;
  if (st.lang && st.lang !== currentLang) {
    currentLang = st.lang;
    if (langSelect) {
      langSelect.value = currentLang;
    }
    applyTranslations();
  }
  renderReadingLight(st);
  renderBackLight(st);
  renderPartyMode(st);
  renderBluetooth(st);
  renderWiFi(st);
  renderVolume(st);
  renderPlayer(st);
});

// Lighting apply
document.getElementById("apply-light").onclick = () => {
  const zone = document.getElementById("zone").value;
  const mode = document.getElementById("mode").value;
  const color = document.getElementById("color").value;
  const brightness = +document.getElementById("brightness").value;
  send("lighting.set", { zone, mode, color, brightness });
};

// Unpairing
document.getElementById("unpair").onclick = () => {
  send("bluetooth.unpair");
};

volumeRange.oninput = () => {
  const vol = +volumeRange.value;
  volumeValue.textContent = vol;
  console.log("Volume set to:", vol);
  send("audio.set_volume", { volume: vol });
};

// Initialize language selector and translations
if (langSelect) {
  langSelect.value = currentLang;
  langSelect.onchange = (e) => setLang(e.target.value);
}
applyTranslations();

    </script>
  </body>
</html>
